<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS - Chiến dịch Đang chạy</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <style>
    /* COPY NGUYÊN CSS TỪ FILE chiendich.html DÁN VÀO ĐÂY */
    /* (Để tiết kiệm không gian chat, mình dùng lại CSS cũ vì nó giống hệt nhau) */
    
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; }
    .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
    .sidebar { background-color: #ffffff; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; }
    .sidebar-header { padding: 25px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-header h3 { margin: 0 0 5px 0; font-size: 20px; }
    .sidebar-header p { margin: 0; font-size: 14px; color: #888; }
    .sidebar-nav { flex-grow: 1; padding: 20px 15px; }
    .sidebar-nav ul { list-style: none; margin: 0; padding: 0; }
    .sidebar-nav li a { display: flex; align-items: center; padding: 14px 18px; text-decoration: none; color: #555; border-radius: 8px; font-weight: 500; margin-bottom: 5px; transition: background-color 0.3s, color 0.3s; }
    .sidebar-nav a i { font-size: 18px; width: 20px; margin-right: 15px; }
    .sidebar-nav a:hover { background-color: #f4f4f4; }
    .sidebar-nav a.active { background-color: #e8f0fe; color: #0d6efd; }
    .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid #f0f0f0; }
    .logout-btn { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: #d9534f; border-radius: 8px; font-weight: 500; transition: background-color 0.3s; margin-bottom: 15px; }
    .logout-btn:hover { background-color: #fdf0f0; }
    .logout-btn i { margin-right: 10px; }
    .user-profile { display: flex; align-items: center; gap: 12px; }
    .user-profile i { font-size: 36px; color: #555; }
    .user-info strong { display: block; font-size: 15px; }
    .user-info span { font-size: 13px; color: #777; }
    .main-content { display: flex; flex-direction: column; height: 100vh; overflow-y: hidden; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
    .top-bar .search-bar { position: relative; width: 300px; }
    .top-bar .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .top-bar .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .notification-btn { background: none; border: none; font-size: 20px; color: #555; cursor: pointer; position: relative; }
    .notification-dot { position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: #dc3545; border-radius: 50%; border: 2px solid #fff; }
    .page-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
    .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title-group .page-title { font-size: 28px; font-weight: 700; margin: 0 0 5px 0; }
    .page-title-group .page-subtitle { font-size: 16px; color: #777; margin: 0; }
    .campaign-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .campaign-stat-card { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e9ecef; display: flex; align-items: center; gap: 15px; }
    .campaign-stat-card.light { background-color: #f8f9fa; }
    .campaign-stat-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .icon-blue { background-color: #e8f0fe; color: #0d6efd; }
    .icon-purple { background-color: #f3e8fe; color: #9333ea; }
    .icon-green { background-color: #e6f8f0; color: #10b981; }
    .icon-red { background-color: #feebea; color: #dc3545; }
    .campaign-stat-info strong { font-size: 20px; font-weight: 700; color: #222; display: block; }
    .campaign-stat-info span { font-size: 14px; color: #777; }
    .filter-bar-container { display: flex; justify-content: space-between; align-items: center; background-color: #ffffff; padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .page-search-bar { position: relative; width: 350px; }
    .page-search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .page-search-bar input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .filter-tabs { display: flex; gap: 10px; }
    .filter-tab { padding: 10px 18px; font-size: 14px; font-weight: 600; color: #555; background-color: transparent; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; text-decoration: none; transition: all 0.3s ease; }
    .filter-tab.active, .filter-tab:hover { background-color: #333; color: #fff; border-color: #333; }
    .campaign-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
    .campaign-card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e9ecef; overflow: hidden; }
    .campaign-image img { width: 100%; height: 220px; object-fit: cover; display: block; }
    .campaign-content { padding: 20px; }
    .campaign-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .campaign-title { font-size: 20px; font-weight: 700; color: #222; }
    .status-tag { font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 15px; }
    .status-running { background-color: #e6f8f0; color: #10b981; }
    .status-active { background-color: #e6f8f0; color: #10b981; }
    .status-scheduled { background-color: #e8f0fe; color: #0d6efd; }
    .status-paused { background-color: #fef9c3; color: #ca8a04; }
    .campaign-desc { font-size: 14px; color: #777; margin-bottom: 15px; }
    .campaign-social-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .social-tag { font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 6px; }
    .tag-facebook { background-color: #e0e7ff; color: #3730a3; }
    .tag-tiktok { background-color: #f3e8ff; color: #581c87; }
    .tag-website { background-color: #e9ecef; color: #555; }
    .tag-zalo { background-color: #dbeafe; color: #1d4ed8; }
    .tag-youtube { background-color: #ffe4e6; color: #e11d48; }
    .tag-google { background-color: #e0f2fe; color: #0369a1; }
    .campaign-budget { font-size: 14px; color: #555; }
    .budget-item { display: flex; justify-content: space-between; }
    .budget-item strong { font-size: 15px; font-weight: 600; color: #333; }
    .campaign-stats { display: grid; grid-template-columns: repeat(3, 1fr); border-top: 1px solid #f0f0f0; margin-top: 20px; }
    .stat-item { padding: 20px; text-align: center; border-right: 1px solid #f0f0f0; }
    .stat-item:last-child { border-right: none; }
    .stat-item strong { display: block; font-size: 20px; font-weight: 700; }
    .stat-item span { font-size: 13px; color: #777; }
    .campaign-footer { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-top: 1px solid #f0f0f0; background-color: #fcfcfc; }
    .date-range { font-size: 13px; font-weight: 500; color: #555; }
    .campaign-actions { display: flex; gap: 10px; }
    .action-btn { display: flex; align-items: center; gap: 6px; background: none; border: 1px solid #ddd; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; color: #555; cursor: pointer; }
    .action-btn:hover { background-color: #f4f4f4; }
    .action-btn.btn-delete:hover { background-color: #feebea; border-color: #fdd; color: #dc3545; }

    @media (max-width: 1200px) { .campaign-grid { grid-template-columns: 1fr; } .campaign-stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 992px) { .filter-bar-container { flex-direction: column; gap: 15px; } .page-search-bar { width: 100%; } }
    @media (max-width: 768px) { .dashboard-layout { grid-template-columns: 1fr; } .sidebar { display: none; } .campaign-stats-grid { grid-template-columns: 1fr; } }
    .notification-popup { position: absolute; top: 60px; right: 25px; width: 300px; background: #ffffff; border-radius: 12px; padding: 15px 18px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); display: none; z-index: 9999; border: 1px solid #e4e4e4; }
    .notif-header h4 { margin: 0; font-size: 16px; font-weight: 700; }
    .notif-sub { font-size: 12px; color: #777; }
    .notif-list { list-style: none; padding: 0; margin: 12px 0 0; }
    .notif-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; }
    .notif-item:last-child { border-bottom: none; }
    .notif-item i { font-size: 18px; margin-top: 2px; }
    .notif-item.urgent i { color: #d9534f; }
    .notif-item.normal i { color: #0d6efd; }
    .notif-item.low i { color: #28a745; }
    .notif-title { margin: 0; font-size: 14px; font-weight: 600; }
    .notif-time { font-size: 12px; color: #888; }
    .notif-view-all { width: 100%; margin-top: 10px; padding: 8px 0; background: #4338ca; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }
    .notif-view-all:hover { background: #3730a3; }
  </style>

  <body>
    <div class="dashboard-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>3CC Hotel CMS</h3>
          <p>Quản trị nội dung</p>
        </div>
        <nav class="sidebar-nav">
          <ul>
            <li><a href="/auth/tongquan.html"><i class="fa-solid fa-chart-pie"></i><span>Tổng quan</span></a></li>
            <li><a href="/auth/quanlybaiviet.html"><i class="fa-solid fa-file-lines"></i><span>Quản lý bài viết</span></a></li>
            <li><a href="/auth/quanlylivestream.html"><i class="fa-solid fa-video"></i><span>Livestream</span></a></li>
            <li><a href="/auth/thuvienmedia.html"><i class="fa-solid fa-photo-film"></i><span>Thư viện media</span></a></li>
            <li><a href="/auth/nguoidung.html"><i class="fa-solid fa-users"></i><span>Người dùng</span></a></li>
            <li><a href="/auth/analyticsvaseo.html"><i class="fa-solid fa-arrow-trend-up"></i><span>Analytics & SEO</span></a></li>
            <li><a href="/auth/binhluan.html"><i class="fa-solid fa-comments"></i><span>Bình luận</span></a></li>
            <li><a href="/auth/chiendich.html" class="active"><i class="fa-solid fa-bullhorn"></i><span>Chiến dịch</span></a></li>
            <li><a href="/auth/xuatban.html"><i class="fa-solid fa-share-nodes"></i><span>Xuất bản đa kênh</span></a></li>
          </ul>
        </nav>
        <div class="sidebar-footer">
          <a href="/auth/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Đăng xuất</span></a>
          <div class="user-profile">
            <i class="fa-solid fa-user-circle"></i>
            <div class="user-info"><strong>ADMIN</strong><span>Quản Trị Viên</span></div>
          </div>
        </div>
      </aside>

      <div class="main-content">
        <header class="top-bar">
          <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Search..." /></div>
          <div class="header-icons">
            <button class="notification-btn"><i class="fa-solid fa-bell"></i><span class="notification-dot"></span></button>
            <div class="notification-popup" id="notificationPopup">
                <div class="notif-header"><h4>Thông báo hệ thống</h4><span class="notif-sub">Dành cho quản trị khách sạn</span></div>
                <ul class="notif-list">
                    <li class="notif-item urgent"><i class="fa-solid fa-triangle-exclamation"></i><div><p class="notif-title">Khách đặt phòng mới</p><span class="notif-time">2 phút trước</span></div></li>
                </ul>
                <button class="notif-view-all">Xem tất cả</button>
            </div>
          </div>
        </header>

        <main class="page-content">
          <div class="page-header-container">
            <div class="page-title-group">
              <h1 class="page-title">Chiến dịch Đã lên lịch</h1>
              <p class="page-subtitle">Quản lý các chiến dịch sắp diễn ra</p>
            </div>
          </div>

          <div class="campaign-stats-grid">
            <div class="campaign-stat-card">
              <div class="campaign-stat-icon icon-blue"><i class="fa-solid fa-bullhorn"></i></div>
              <div class="campaign-stat-info"><strong id="stat-total">0</strong><span>Tổng chiến dịch</span></div>
            </div>
            <div class="campaign-stat-card">
              <div class="campaign-stat-icon icon-purple"><i class="fa-solid fa-wallet"></i></div>
              <div class="campaign-stat-info"><strong id="stat-budget">0 ₫</strong><span>Tổng ngân sách</span></div>
            </div>
            <div class="campaign-stat-card">
              <div class="campaign-stat-icon icon-green"><i class="fa-solid fa-play"></i></div>
              <div class="campaign-stat-info"><strong id="stat-active">0</strong><span>Đang chạy</span></div>
            </div>
            <div class="campaign-stat-card light">
              <div class="campaign-stat-icon icon-red"><i class="fa-solid fa-money-bill-wave"></i></div>
              <div class="campaign-stat-info"><strong id="stat-spent">0 ₫</strong><span>Đã chi tiêu</span></div>
            </div>
          </div>

          <div class="filter-bar-container">
            <div class="page-search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Tìm kiếm chiến dịch..." /></div>
            <div class="filter-tabs">
              <a href="/auth/chiendich.html" class="filter-tab">Tất cả</a>
              <a href="/auth/chiendichdangchay.html" class="filter-tab">Đang chạy</a>
              <a href="/auth/chiendichdalenlich.html" class="filter-tab active">Đã lên lịch</a>
              <a href="/auth/chiendichtamdung.html" class="filter-tab">Tạm dừng</a>
            </div>
          </div>

          <div class="campaign-grid" id="campaignList">
             <p style="text-align:center; padding:20px;">Đang tải dữ liệu...</p>
          </div>
        </main>
      </div>
    </div>

    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:12px; width:400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">Cập nhật chiến dịch</h3>
            <input type="hidden" id="edit-id">
            <div style="margin-bottom:15px;"><label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Ngân sách (VNĐ)</label><input type="number" id="edit-budget" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
            <div style="margin-bottom:15px;"><label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Đã chi tiêu (VNĐ)</label><input type="number" id="edit-spent" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
            <div style="display:flex; gap:15px; margin-bottom:25px;">
                <div style="flex:1"><label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Ngày bắt đầu</label><input type="date" id="edit-start" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
                <div style="flex:1"><label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Ngày kết thúc</label><input type="date" id="edit-end" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
            </div>
            <div style="text-align:right;">
                <button onclick="document.getElementById('editModal').style.display='none'" style="padding:10px 20px; background:#f0f2f5; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:#555; margin-right:10px;">Hủy</button>
                <button onclick="submitEdit()" style="padding:10px 20px; background:#4338ca; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <script>
      const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
      const getPlatformIcon = (p) => {
          if(p === 'facebook') return 'Facebook'; if(p === 'google') return 'Google'; if(p === 'tiktok') return 'Tiktok'; if(p === 'youtube') return 'Youtube'; return 'Website';
      }
      const getPlatformClass = (p) => {
          if(p === 'facebook') return 'tag-facebook'; if(p === 'google') return 'tag-google'; if(p === 'tiktok') return 'tag-tiktok'; if(p === 'youtube') return 'tag-youtube'; return 'tag-website';
      }
      function getImageForCampaign(name) {
          const n = name.toLowerCase();
          if(n.includes('phòng') || n.includes('suite')) return '../static/images/phong1.png';
          if(n.includes('tết') || n.includes('lễ')) return '../static/images/lehoi.png';
          if(n.includes('ăn') || n.includes('thực')) return '../static/images/amthuc.png';
          return '../static/images/khachhang.png';
      }
      function getCurrentTab() {
          if(window.location.href.includes('chiendichdangchay')) return 'active';
          if(window.location.href.includes('chiendichdalenlich')) return 'scheduled';
          if(window.location.href.includes('chiendichtamdung')) return 'paused';
          return 'all'; 
      }
      async function loadData() {
          const container = document.getElementById('campaignList');
          if(!container) return;
          container.innerHTML = '<p style="text-align:center; padding:20px;">Đang tải dữ liệu...</p>';
          try {
              const res = await fetch(`/auth/api/campaigns?status=${getCurrentTab()}`);
              const campaigns = await res.json();
              calculateStats(campaigns);
              container.innerHTML = '';
              if(campaigns.length === 0) { container.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">Chưa có chiến dịch nào.</p>'; return; }
              campaigns.forEach(c => {
                  let statusBtn = '';
                  if(c.status === 'active') statusBtn = `<button class="action-btn" onclick="updateStatus(${c.id}, 'paused')"><i class="fa-solid fa-pause"></i> Tạm dừng</button>`;
                  else if(c.status === 'paused') statusBtn = `<button class="action-btn" onclick="updateStatus(${c.id}, 'active')"><i class="fa-solid fa-play"></i> Tiếp tục</button>`;
                  
                  const html = `
                  <article class="campaign-card">
                    <div class="campaign-image"><img src="${getImageForCampaign(c.name)}" alt="${c.name}" onerror="this.src='../static/images/khachhang.png'" /></div>
                    <div class="campaign-content">
                      <div class="campaign-header"><h3 class="campaign-title">${c.name}</h3><span class="status-tag status-${c.status}">${c.status==='active'?'Đang chạy':(c.status==='paused'?'Tạm dừng':(c.status==='scheduled'?'Đã lên lịch':'Hoàn thành'))}</span></div>
                      <p class="campaign-desc">Chiến dịch trên ${c.platform} với ngân sách ${formatCurrency(c.budget)}</p>
                      <div class="campaign-social-tags"><span class="social-tag ${getPlatformClass(c.platform)}">${getPlatformIcon(c.platform)}</span></div>
                      <div class="campaign-budget"><div class="budget-item"><span>Ngân sách:</span><strong>${formatCurrency(c.budget)}</strong></div><div class="budget-item"><span>Chi tiêu:</span><strong>${formatCurrency(c.spent)}</strong></div></div>
                    </div>
                    <div class="campaign-stats"><div class="stat-item"><strong>${c.reach}</strong><span>Tiếp cận</span></div><div class="stat-item"><strong>${c.clicks}</strong><span>Clicks</span></div><div class="stat-item"><strong>${c.conversions}</strong><span>Chuyển đổi</span></div></div>
                    <div class="campaign-footer"><span class="date-range">${c.start_date_display} &rarr; ${c.end_date_display}</span>
                      <div class="campaign-actions">${statusBtn}<button class="action-btn" onclick="openEditModal(${c.id})"><i class="fa-solid fa-pencil"></i> Sửa</button><button class="action-btn btn-delete" onclick="deleteCampaign(${c.id})"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                  </article>`;
                  container.insertAdjacentHTML('beforeend', html);
              });
          } catch(e) { console.error(e); container.innerHTML = '<p style="text-align:center; color:red">Lỗi kết nối API</p>'; }
      }
      async function calculateStats(currentList) {
        try {
            const res = await fetch('/auth/api/campaigns/stats');
            const data = await res.json();
            if(document.getElementById('stat-total')) document.getElementById('stat-total').innerText = data.total;
            if(document.getElementById('stat-active')) document.getElementById('stat-active').innerText = data.active;
            if (getCurrentTab() === 'all') {
                let totalBudget = 0; let totalSpent = 0;
                currentList.forEach(c => { totalBudget += c.budget; totalSpent += c.spent; });
                if(document.getElementById('stat-budget')) document.getElementById('stat-budget').innerText = formatCurrency(totalBudget);
                if(document.getElementById('stat-spent')) document.getElementById('stat-spent').innerText = formatCurrency(totalSpent);
            }
        } catch(e) {}
      }
      async function updateStatus(id, newStatus) { await fetch(`/auth/api/campaigns/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ status: newStatus }) }); loadData(); }
      async function deleteCampaign(id) { if(confirm("Bạn có chắc muốn xóa không?")) { await fetch(`/auth/api/campaigns/${id}`, { method: 'DELETE' }); loadData(); } }
      async function openEditModal(id) { const res = await fetch(`/auth/api/campaigns/${id}`); const c = await res.json(); document.getElementById('edit-id').value = c.id; document.getElementById('edit-budget').value = c.budget; document.getElementById('edit-spent').value = c.spent; document.getElementById('edit-start').value = c.start_date; document.getElementById('edit-end').value = c.end_date; document.getElementById('editModal').style.display = 'flex'; }
      async function submitEdit() { const id = document.getElementById('edit-id').value; const data = { budget: document.getElementById('edit-budget').value, spent: document.getElementById('edit-spent').value, start_date: document.getElementById('edit-start').value, end_date: document.getElementById('edit-end').value }; await fetch(`/auth/api/campaigns/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); document.getElementById('editModal').style.display = 'none'; loadData(); }
      
      const bell = document.querySelector(".notification-btn"); const popup = document.getElementById("notificationPopup");
      bell.addEventListener("click", (e) => { e.stopPropagation(); popup.style.display = popup.style.display === "block" ? "none" : "block"; });
      document.addEventListener("click", () => { popup.style.display = "none"; });
      document.addEventListener("DOMContentLoaded", loadData);
    </script>
  </body>
</html>
