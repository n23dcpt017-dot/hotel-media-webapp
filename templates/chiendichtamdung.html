<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>CMS - Tất cả chiến dịch</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<style>
    /* CSS CƠ BẢN (Dùng chung cho cả 4 file) */
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, sans-serif; background-color: #f0f2f5; color: #333; }
    .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
    .sidebar { background-color: #ffffff; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; }
    .sidebar-header { padding: 25px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-nav { flex-grow: 1; padding: 20px 15px; }
    .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar-nav li a { display: flex; align-items: center; padding: 14px 18px; text-decoration: none; color: #555; border-radius: 8px; font-weight: 500; margin-bottom: 5px; }
    .sidebar-nav a:hover { background-color: #f4f4f4; }
    .sidebar-nav a.active { background-color: #e8f0fe; color: #0d6efd; }
    .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid #f0f0f0; }
    .logout-btn { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: #d9534f; border-radius: 8px; }
    .logout-btn:hover { background-color: #fdf0f0; }
    .main-content { display: flex; flex-direction: column; height: 100vh; overflow-y: hidden; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: #fff; border-bottom: 1px solid #e0e0e0; }
    .page-content { flex-grow: 1; padding: 30px; overflow-y: auto; }

    /* CSS RIÊNG CHIẾN DỊCH */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .stat-info strong { display: block; font-size: 24px; color: #333; }
    .stat-info span { color: #666; font-size: 14px; }
    
    .campaign-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .campaign-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; }
    .campaign-header { display: flex; gap: 15px; margin-bottom: 15px; }
    .platform-icon { width: 40px; height: 40px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .campaign-name { font-size: 16px; margin: 0 0 5px 0; font-weight: 600; line-height: 1.4; }
    .campaign-status { font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: 500; }
    
    .status-active { background: #dcfce7; color: #166534; }
    .status-paused { background: #fef9c3; color: #854d0e; }
    .status-scheduled { background: #dbeafe; color: #1e40af; }
    
    .campaign-meta { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
    .campaign-stats { display: flex; justify-content: space-between; margin-bottom: 15px; text-align: center; }
    .stat-item strong { display: block; font-size: 16px; color: #333; }
    .stat-item span { font-size: 12px; color: #888; }
    .campaign-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666; }
    .campaign-actions { display: flex; gap: 5px; }
    .action-btn { padding: 6px 10px; border: 1px solid #eee; background: white; border-radius: 6px; cursor: pointer; color: #555; }
    .action-btn:hover { background: #f8f9fa; }
    .btn-delete:hover { background: #fee2e2; color: #ef4444; border-color: #fee2e2; }

    .icon-blue { background: #e0f2fe; color: #0284c7; }
    .icon-green { background: #dcfce7; color: #16a34a; }
    .icon-orange { background: #ffedd5; color: #ea580c; }
    .icon-yellow { background: #fef9c3; color: #ca8a04; }
</style>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header"><h3>3CC Hotel CMS</h3><p>Quản trị nội dung</p></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/auth/tongquan.html"><i class="fa-solid fa-chart-pie"></i><span>Tổng quan</span></a></li>
                    <li><a href="/auth/quanlybaiviet.html"><i class="fa-solid fa-file-lines"></i><span>Quản lý bài viết</span></a></li>
                    <li><a href="/auth/chiendich.html" class="active"><i class="fa-solid fa-bullhorn"></i><span>Chiến dịch</span></a></li>
                    <li><a href="/auth/nguoidung.html"><i class="fa-solid fa-users"></i><span>Người dùng</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><a href="/auth/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Đăng xuất</span></a></div>
        </aside>

        <div class="main-content">
            <header class="top-bar">
                <div class="search-bar"><input type="text" placeholder="Tìm kiếm..."></div>
                <div class="header-icons"><button class="notification-btn"><i class="fa-solid fa-bell"></i></button></div>
            </header>

            <main class="page-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h2>Quản lý chiến dịch</h2>
                    <div class="filter-tabs">
                        <a href="/auth/chiendich.html" class="action-btn">Tất cả</a>
                        <a href="/auth/chiendichdangchay.html" class="action-btn">Đang chạy</a>
                        <a href="/auth/chiendichdalenlich.html" class="action-btn">Đã lên lịch</a>
                        <a href="/auth/chiendichtamdung.html" class="action-btn" style="background:#4338ca; color:white;">Tạm dừng</a>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon icon-blue"><i class="fa-solid fa-layer-group"></i></div><div class="stat-info"><strong id="stat-total">0</strong><span>Tổng</span></div></div>
                    <div class="stat-card"><div class="stat-icon icon-green"><i class="fa-solid fa-bolt"></i></div><div class="stat-info"><strong id="stat-active">0</strong><span>Đang chạy</span></div></div>
                    <div class="stat-card"><div class="stat-icon icon-orange"><i class="fa-regular fa-calendar-check"></i></div><div class="stat-info"><strong id="stat-scheduled">0</strong><span>Lên lịch</span></div></div>
                    <div class="stat-card"><div class="stat-icon icon-yellow"><i class="fa-solid fa-pause"></i></div><div class="stat-info"><strong id="stat-paused">0</strong><span>Tạm dừng</span></div></div>
                </div>

                <div class="campaign-grid" id="campaignList"><p>Đang tải dữ liệu...</p></div>
            </main>
        </div>
    </div>

    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:25px; border-radius:12px; width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0;">Cập nhật chiến dịch</h3>
            <input type="hidden" id="edit-id">
            <div style="margin-bottom:10px;"><label>Ngân sách (VNĐ)</label><input type="number" id="edit-budget" style="width:100%; padding:8px; margin-top:5px;"></div>
            <div style="margin-bottom:10px;"><label>Đã chi tiêu (VNĐ)</label><input type="number" id="edit-spent" style="width:100%; padding:8px; margin-top:5px;"></div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div><label>Bắt đầu</label><input type="date" id="edit-start" style="width:100%; padding:8px; margin-top:5px;"></div>
                <div><label>Kết thúc</label><input type="date" id="edit-end" style="width:100%; padding:8px; margin-top:5px;"></div>
            </div>
            <div style="text-align:right;">
                <button onclick="document.getElementById('editModal').style.display='none'" style="padding:8px 15px; margin-right:5px; cursor:pointer">Hủy</button>
                <button onclick="submitEdit()" style="padding:8px 15px; background:#4338ca; color:white; border:none; cursor:pointer">Lưu</button>
            </div>
        </div>
    </div>

    <script>
        // 1. Helpers
        const formatCurrency = (amt) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amt);
        const getPlatformIcon = (p) => {
            if(p==='facebook') return '<i class="fa-brands fa-facebook" style="color:#1877F2"></i>';
            if(p==='google') return '<i class="fa-brands fa-google" style="color:#DB4437"></i>';
            if(p==='tiktok') return '<i class="fa-brands fa-tiktok" style="color:#000"></i>';
            if(p==='youtube') return '<i class="fa-brands fa-youtube" style="color:#FF0000"></i>';
            return '<i class="fa-solid fa-bullhorn"></i>';
        };

        // 2. Xác định Tab
        function getCurrentTab() {
            if(window.location.href.includes('chiendichdangchay')) return 'active';
            if(window.location.href.includes('chiendichdalenlich')) return 'scheduled';
            if(window.location.href.includes('chiendichtamdung')) return 'paused';
            return 'all';
        }

        // 3. Tải dữ liệu
        async function loadData() {
            // Stats
            try { const r = await fetch('/auth/api/campaigns/stats'); const d = await r.json(); ['total','active','scheduled','paused'].forEach(k=>{if(document.getElementById(`stat-${k}`)) document.getElementById(`stat-${k}`).innerText=d[k]}); } catch(e){}
            
            // List
            const container = document.getElementById('campaignList');
            try {
                const res = await fetch(`/auth/api/campaigns?status=${getCurrentTab()}`);
                const data = await res.json();
                container.innerHTML = '';
                if(data.length===0) { container.innerHTML='<p style="text-align:center;width:100%">Không có dữ liệu.</p>'; return; }

                data.forEach(c => {
                    let btn = '';
                    if(c.status==='active') btn = `<button class="action-btn" onclick="updateStatus(${c.id}, 'paused')" title="Tạm dừng"><i class="fa-solid fa-pause"></i> Tạm dừng</button>`;
                    else if(c.status==='paused') btn = `<button class="action-btn" onclick="updateStatus(${c.id}, 'active')" title="Tiếp tục"><i class="fa-solid fa-play"></i> Tiếp tục</button>`;
                    
                    const html = `
                    <article class="campaign-card">
                        <div class="campaign-header">
                            <div class="platform-icon">${getPlatformIcon(c.platform)}</div>
                            <div class="campaign-info"><h3 class="campaign-name">${c.name}</h3><span class="campaign-status status-${c.status}">${c.status==='active'?'Đang chạy':(c.status==='paused'?'Tạm dừng':(c.status==='scheduled'?'Đã lên lịch':'Hoàn thành'))}</span></div>
                        </div>
                        <div class="campaign-meta"><div>Budget: <strong>${formatCurrency(c.budget)}</strong></div><div>Spent: <strong>${formatCurrency(c.spent)}</strong></div></div>
                        <div class="campaign-stats">
                            <div class="stat-item"><strong>${c.reach}</strong><span>Reach</span></div>
                            <div class="stat-item"><strong>${c.clicks}</strong><span>Clicks</span></div>
                            <div class="stat-item"><strong>${c.conversions}</strong><span>Conv.</span></div>
                        </div>
                        <div class="campaign-footer">
                            <span class="date-range">${c.start_date_display} &rarr; ${c.end_date_display}</span>
                            <div class="campaign-actions">${btn}<button class="action-btn" onclick="openEdit(${c.id})"><i class="fa-solid fa-pencil"></i></button><button class="action-btn btn-delete" onclick="delCamp(${c.id})"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                    </article>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } catch(e) { container.innerHTML='<p>Lỗi tải dữ liệu.</p>'; }
        }

        // 4. Actions
        async function updateStatus(id, s) { await fetch(`/auth/api/campaigns/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:s})}); loadData(); }
        async function delCamp(id) { if(confirm("Xóa chiến dịch này?")) { await fetch(`/auth/api/campaigns/${id}`, {method:'DELETE'}); loadData(); } }
        
        // 5. Modal Logic
        async function openEdit(id) {
            const res = await fetch(`/auth/api/campaigns/${id}`);
            const c = await res.json();
            document.getElementById('edit-id').value = c.id;
            document.getElementById('edit-budget').value = c.budget;
            document.getElementById('edit-spent').value = c.spent;
            document.getElementById('edit-start').value = c.start_date;
            document.getElementById('edit-end').value = c.end_date;
            document.getElementById('editModal').style.display = 'flex';
        }
        async function submitEdit() {
            const id = document.getElementById('edit-id').value;
            const data = { budget:document.getElementById('edit-budget').value, spent:document.getElementById('edit-spent').value, start_date:document.getElementById('edit-start').value, end_date:document.getElementById('edit-end').value };
            await fetch(`/auth/api/campaigns/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            document.getElementById('editModal').style.display='none';
            loadData();
        }

        document.addEventListener("DOMContentLoaded", loadData);
    </script>
</body>
</html>
