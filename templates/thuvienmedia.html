<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS - Thư viện Media</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <style>
    /* style.css - Giữ nguyên các style cơ bản */
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; }
    a { text-decoration: none; }
    .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
    
    /* Sidebar */
    .sidebar { background-color: #ffffff; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; }
    .sidebar-header { padding: 25px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-header h3 { margin: 0 0 5px 0; font-size: 20px; }
    .sidebar-header p { margin: 0; font-size: 14px; color: #888; }
    .sidebar-nav { flex-grow: 1; padding: 20px 15px; }
    .sidebar-nav ul { list-style: none; margin: 0; padding: 0; }
    .sidebar-nav li a { display: flex; align-items: center; padding: 14px 18px; text-decoration: none; color: #555; border-radius: 8px; font-weight: 500; margin-bottom: 5px; transition: 0.3s; }
    .sidebar-nav a i { font-size: 18px; width: 20px; margin-right: 15px; }
    .sidebar-nav a:hover { background-color: #f4f4f4; }
    .sidebar-nav a.active { background-color: #e8f0fe; color: #0d6efd; }
    .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid #f0f0f0; }
    .logout-btn { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: #d9534f; border-radius: 8px; font-weight: 500; transition: 0.3s; margin-bottom: 15px; }
    .logout-btn:hover { background-color: #fdf0f0; }
    .logout-btn i { margin-right: 10px; }
    .user-profile { display: flex; align-items: center; gap: 12px; }
    .user-profile i { font-size: 36px; color: #555; }
    .user-info strong { display: block; font-size: 15px; }
    .user-info span { font-size: 13px; color: #777; }
    
    /* Main Content */
    .main-content { display: flex; flex-direction: column; height: 100vh; overflow-y: hidden; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
    .top-bar .search-bar { position: relative; width: 300px; }
    .top-bar .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .top-bar .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .notification-btn { background: none; border: none; font-size: 20px; color: #555; cursor: pointer; position: relative; }
    .notification-dot { position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: #dc3545; border-radius: 50%; border: 2px solid #fff; }
    .page-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
    
    /* CSS Thư viện Media */
    .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title-group .page-title { font-size: 28px; font-weight: 700; margin: 0 0 5px 0; }
    .page-title-group .page-subtitle { font-size: 16px; color: #777; margin: 0; }
    .btn-upload { display: flex; align-items: center; gap: 8px; background-color: #4338ca; color: #ffffff; border: none; padding: 12px 20px; font-size: 15px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    .btn-upload:hover { background-color: #3730a3; }
    
    .media-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .media-stat-card { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e9ecef; display: flex; align-items: center; gap: 15px; }
    .media-stat-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .icon-blue { background-color: #e8f0fe; color: #0d6efd; }
    .icon-purple { background-color: #f3e8fe; color: #9333ea; }
    .icon-green { background-color: #e6f8f0; color: #10b981; }
    .icon-red { background-color: #feebea; color: #dc3545; }
    .media-stat-info strong { font-size: 20px; font-weight: 700; color: #222; display: block; }
    .media-stat-info span { font-size: 14px; color: #777; }

    .filter-bar-container { display: flex; justify-content: space-between; align-items: center; background-color: #ffffff; padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .page-search-bar { position: relative; width: 350px; }
    .page-search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .page-search-bar input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    .filter-tabs { display: flex; gap: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 4px; background-color: #f9f9f9; }
    .filter-tab { padding: 8px 16px; font-size: 14px; font-weight: 600; color: #555; background-color: transparent; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    .filter-tab.active { background-color: #ffffff; color: #333; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
    
    .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
    .media-card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e9ecef; overflow: hidden; position: relative; }
    .media-preview { width: 100%; height: 220px; object-fit: cover; display: block; background-color: #f0f2f5; }
    .video-preview { background-color: #222; display: flex; align-items: center; justify-content: center; position: relative; width: 100%; height: 220px; }
    .video-preview i { font-size: 60px; color: #fff; }
    .media-info { padding: 15px 20px; }
    .media-info strong { display: block; font-size: 16px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .media-details { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #777; margin-top: 5px; }
    .media-tag { font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 15px; color: #fff; margin-top: 5px; display: inline-block; }
    .tag-image { background-color: #0d6efd; }
    .tag-video { background-color: #9333ea; }
    .media-actions { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px 15px 20px; border-top: 1px solid #f0f0f0; }
    .action-btn { background: none; border: 1px solid #ddd; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 14px; color: #777; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
    .action-btn:hover { background-color: #f4f4f4; }
    .action-btn.btn-delete:hover { background-color: #feebea; border-color: #fdd; color: #dc3545; }

    /* Popup thông báo */
    .notification-popup { position: absolute; top: 60px; right: 25px; width: 300px; background: #ffffff; border-radius: 12px; padding: 15px 18px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); display: none; z-index: 9999; border: 1px solid #e4e4e4; }
    .notif-header h4 { margin: 0; font-size: 16px; font-weight: 700; }
    .notif-sub { font-size: 12px; color: #777; }
    .notif-list { list-style: none; padding: 0; margin: 12px 0 0; }
    .notif-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; }
    .notif-item i { font-size: 18px; margin-top: 2px; }
    .notif-title { margin: 0; font-size: 14px; font-weight: 600; }
    .notif-time { font-size: 12px; color: #888; }
    .notif-view-all { width: 100%; margin-top: 10px; padding: 8px 0; background: #4338ca; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }

    @media (max-width: 1200px) { .media-grid { grid-template-columns: repeat(2, 1fr); } .media-stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 992px) { .filter-bar-container { flex-direction: column; gap: 15px; } .page-search-bar { width: 100%; } }
    @media (max-width: 768px) { .dashboard-layout { grid-template-columns: 1fr; } .sidebar { display: none; } .media-grid { grid-template-columns: 1fr; } .media-stats-grid { grid-template-columns: 1fr; } }
  </style>

  <body>
    <div class="dashboard-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>3CC Hotel CMS</h3>
          <p>Quản trị nội dung</p>
        </div>
        <nav class="sidebar-nav">
          <ul>
            <li><a href="/auth/tongquan.html"><i class="fa-solid fa-chart-pie"></i><span>Tổng quan</span></a></li>
            <li><a href="/auth/quanlybaiviet.html"><i class="fa-solid fa-file-lines"></i><span>Quản lý bài viết</span></a></li>
            <li><a href="/auth/quanlylivestream.html"><i class="fa-solid fa-video"></i><span>Livestream</span></a></li>
            <li><a href="/auth/thuvienmedia.html" class="active"><i class="fa-solid fa-photo-film"></i><span>Thư viện media</span></a></li>
            <li><a href="/auth/nguoidung.html"><i class="fa-solid fa-users"></i><span>Người dùng</span></a></li>
            <li><a href="/auth/analyticsvaseo.html"><i class="fa-solid fa-arrow-trend-up"></i><span>Analytics & SEO</span></a></li>
            <li><a href="/auth/binhluan.html"><i class="fa-solid fa-comments"></i><span>Bình luận</span></a></li>
            <li><a href="/auth/chiendich.html"><i class="fa-solid fa-bullhorn"></i><span>Chiến dịch</span></a></li>
            <li><a href="/auth/xuatban.html"><i class="fa-solid fa-share-nodes"></i><span>Xuất bản đa kênh</span></a></li>
          </ul>
        </nav>
        <div class="sidebar-footer">
          <a href="/auth/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Đăng xuất</span></a>
          <div class="user-profile"><i class="fa-solid fa-user-circle"></i><div class="user-info"><strong>ADMIN</strong><span>Quản Trị Viên</span></div></div>
        </div>
      </aside>

      <div class="main-content">
        <header class="top-bar">
          <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Search..." /></div>
          <div class="header-icons"><button class="notification-btn"><i class="fa-solid fa-bell"></i><span class="notification-dot"></span></button></div>
          <div class="notification-popup" id="notificationPopup">
            <div class="notif-header"><h4>Thông báo hệ thống</h4><span class="notif-sub">Dành cho quản trị khách sạn</span></div>
            <ul class="notif-list">
                <li class="notif-item normal"><i class="fa-solid fa-circle-info" style="color:#0d6efd"></i><div><p class="notif-title">Yêu cầu hỗ trợ từ lễ tân</p><span class="notif-time">10 phút trước</span></div></li>
            </ul>
            <button class="notif-view-all">Xem tất cả</button>
          </div>
        </header>

        <main class="page-content">
          <div class="page-header-container">
            <div class="page-title-group">
              <h1 class="page-title">Thư viện media</h1>
              <p class="page-subtitle">Quản lý ảnh và video của khách sạn</p>
            </div>
            <button class="btn-upload" id="btnUpload"><i class="fa-solid fa-upload"></i> Upload Media</button>
            <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display:none" />
          </div>

          <div class="media-stats-grid">
            <div class="media-stat-card">
              <div class="media-stat-icon icon-blue"><i class="fa-solid fa-image"></i></div>
              <div class="media-stat-info"><strong id="stat-images">0</strong><span>Tổng ảnh</span></div>
            </div>
            <div class="media-stat-card">
              <div class="media-stat-icon icon-purple"><i class="fa-solid fa-video"></i></div>
              <div class="media-stat-info"><strong id="stat-videos">0</strong><span>Tổng video</span></div>
            </div>
            <div class="media-stat-card">
              <div class="media-stat-icon icon-green"><i class="fa-solid fa-arrow-up"></i></div>
              <div class="media-stat-info"><strong id="stat-total">0</strong><span>Tổng file</span></div>
            </div>
            <div class="media-stat-card">
                <div class="media-stat-icon icon-red"><i class="fa-solid fa-database"></i></div>
                <div class="media-stat-info"><strong>2.4 GB</strong><span>Dung lượng</span></div>
            </div>
          </div>

          <div class="filter-bar-container">
            <div class="page-search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" id="searchInput" placeholder="Tìm kiếm media..." /></div>
            <div class="filter-group">
              <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterMedia('all')">Tất cả</button>
                <button class="filter-tab" onclick="filterMedia('image')">Ảnh</button>
                <button class="filter-tab" onclick="filterMedia('video')">Video</button>
              </div>
            </div>
          </div>

          <div class="media-grid" id="mediaGrid">
             <p style="grid-column: 1/-1; text-align: center;">Đang tải dữ liệu...</p>
          </div>
        </main>
      </div>
    </div>

<script>
// --- LOGIC QUẢN LÝ MEDIA ---
let allMedia = []; // Lưu trữ toàn bộ media để filter client-side cho nhanh

document.addEventListener("DOMContentLoaded", () => {
    loadMedia();
    setupUpload();
});

// 1. Tải danh sách Media từ Server
async function loadMedia() {
    try {
        const res = await fetch("/auth/api/media");
        allMedia = await res.json();
        
        updateStats();
        renderMedia(allMedia);
    } catch (err) {
        console.error(err);
        document.getElementById("mediaGrid").innerHTML = `<p style="text-align:center; color:red; grid-column:1/-1">Lỗi tải dữ liệu</p>`;
    }
}

// 2. Cập nhật số liệu thống kê
function updateStats() {
    const images = allMedia.filter(m => m.type === 'image').length;
    const videos = allMedia.filter(m => m.type === 'video').length;
    
    document.getElementById("stat-images").innerText = images;
    document.getElementById("stat-videos").innerText = videos;
    document.getElementById("stat-total").innerText = allMedia.length;
}

// 3. Render HTML
function renderMedia(data) {
    const grid = document.getElementById("mediaGrid");
    grid.innerHTML = "";

    if (data.length === 0) {
        grid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: #888;">Không có file nào.</p>`;
        return;
    }

    data.forEach(m => {
        const card = document.createElement("div");
        card.className = "media-card";
        
        let previewHtml = "";
        let tagHtml = "";
        
        if (m.type === "video") {
            previewHtml = `
                <div class="media-preview video-preview">
                    <i class="fa-solid fa-play"></i>
                </div>
            `;
            tagHtml = `<span class="media-tag tag-video mt-2">Video</span>`;
            card.dataset.video = m.url;
        } else {
            previewHtml = `<img src="${m.url}" class="media-preview" onerror="this.src='/static/images/default.png'"/>`;
            tagHtml = `<span class="media-tag tag-image mt-2">Ảnh</span>`;
        }

        card.innerHTML = `
            ${previewHtml}
            <div class="media-info">
                <strong title="${m.filename}">${m.filename}</strong>
                <div class="media-details">
                    <span>${m.size || '-'}</span>
                    <span>${m.created_at}</span>
                </div>
                ${tagHtml}
            </div>
            <div class="media-actions">
                <a href="${m.url}" target="_blank" class="action-btn"><i class="fa-solid fa-eye"></i></a>
                <a href="${m.url}" download class="action-btn"><i class="fa-solid fa-download"></i></a>
                <button class="action-btn btn-delete" onclick="deleteMedia(${m.id})"><i class="fa-solid fa-trash"></i></button>
            </div>
        `;
        
        // Click vào card để mở video (trừ nút action)
        card.addEventListener('click', (e) => {
            if (!e.target.closest('.media-actions') && m.type === 'video') {
                window.open(m.url, '_blank');
            }
        });

        grid.appendChild(card);
    });
}

// 4. Xử lý Upload
function setupUpload() {
    const btnUpload = document.getElementById("btnUpload");
    const mediaInput = document.getElementById("mediaInput");

    btnUpload.addEventListener("click", () => mediaInput.click());

    mediaInput.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        // Upload từng file
        for (const file of files) {
            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("/auth/api/media/upload", {
                    method: "POST",
                    body: formData
                });
                if (!res.ok) throw new Error("Upload lỗi");
            } catch (err) {
                console.error("Lỗi upload file:", file.name);
                alert(`Lỗi upload file: ${file.name}`);
            }
        }
        
        mediaInput.value = ""; // Reset input
        loadMedia(); // Tải lại danh sách
    });
}

// 5. Xóa Media
async function deleteMedia(id) {
    if (!confirm("Bạn chắc chắn muốn xóa file này vĩnh viễn?")) return;

    try {
        const res = await fetch(`/auth/api/media/${id}`, { method: "DELETE" });
        if (res.ok) {
            loadMedia(); 
        } else {
            alert("Xóa thất bại");
        }
    } catch (err) {
        alert("Lỗi kết nối");
    }
}

// 6. Filter & Search Client-side
function filterMedia(type) {
    document.querySelectorAll('.filter-tab').forEach(btn => {
        if (btn.innerText === 'Tất cả' && type === 'all') btn.classList.add('active');
        else if (btn.innerText === 'Ảnh' && type === 'image') btn.classList.add('active');
        else if (btn.innerText === 'Video' && type === 'video') btn.classList.add('active');
        else btn.classList.remove('active');
    });

    let filtered = allMedia;
    if (type !== 'all') {
        filtered = allMedia.filter(m => m.type === type);
    }
    renderMedia(filtered);
}

document.getElementById('searchInput').addEventListener('keyup', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = allMedia.filter(m => m.filename.toLowerCase().includes(term));
    renderMedia(filtered);
});

// Popup thông báo
const bell = document.querySelector(".notification-btn");
const popup = document.getElementById("notificationPopup");
bell.addEventListener("click", (e) => { e.stopPropagation(); popup.style.display = popup.style.display === "block" ? "none" : "block"; });
document.addEventListener("click", () => popup.style.display = "none");
</script>
</body>
</html>
