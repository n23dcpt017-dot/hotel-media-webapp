<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS - Quản lý người dùng</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <style>
    /* style.css - Giữ nguyên các style cơ bản */
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; }
    a { text-decoration: none; }
    .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
    
    /* Sidebar */
    .sidebar { background-color: #ffffff; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; }
    .sidebar-header { padding: 25px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-header h3 { margin: 0 0 5px 0; font-size: 20px; }
    .sidebar-header p { margin: 0; font-size: 14px; color: #888; }
    .sidebar-nav { flex-grow: 1; padding: 20px 15px; }
    .sidebar-nav ul { list-style: none; margin: 0; padding: 0; }
    .sidebar-nav li a { display: flex; align-items: center; padding: 14px 18px; text-decoration: none; color: #555; border-radius: 8px; font-weight: 500; margin-bottom: 5px; transition: 0.3s; }
    .sidebar-nav a i { font-size: 18px; width: 20px; margin-right: 15px; }
    .sidebar-nav a:hover { background-color: #f4f4f4; }
    .sidebar-nav a.active { background-color: #e8f0fe; color: #0d6efd; }
    .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid #f0f0f0; }
    .logout-btn { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: #d9534f; border-radius: 8px; font-weight: 500; transition: 0.3s; margin-bottom: 15px; }
    .logout-btn:hover { background-color: #fdf0f0; }
    .logout-btn i { margin-right: 10px; }
    .user-profile { display: flex; align-items: center; gap: 12px; }
    .user-profile i { font-size: 36px; color: #555; }
    .user-info strong { display: block; font-size: 15px; }
    .user-info span { font-size: 13px; color: #777; }
    
    /* Main Content */
    .main-content { display: flex; flex-direction: column; height: 100vh; overflow-y: hidden; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
    .top-bar .search-bar { position: relative; width: 300px; }
    .top-bar .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .top-bar .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .notification-btn { background: none; border: none; font-size: 20px; color: #555; cursor: pointer; position: relative; }
    .notification-dot { position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: #dc3545; border-radius: 50%; border: 2px solid #fff; }
    .page-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
    
    /* Styles riêng trang Người dùng */
    .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title-group .page-title { font-size: 28px; font-weight: 700; margin: 0 0 5px 0; }
    .page-title-group .page-subtitle { font-size: 16px; color: #777; margin: 0; }
    
    .btn-add-user { display: flex; align-items: center; gap: 8px; background-color: #4338ca; color: #ffffff; border: none; padding: 12px 20px; font-size: 15px; font-weight: 600; border-radius: 8px; cursor: pointer; text-decoration: none; transition: 0.3s; }
    .btn-add-user:hover { background-color: #3730a3; }
    
    /* Stats Grid */
    .user-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .user-stat-card { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e9ecef; display: flex; align-items: center; gap: 15px; }
    .user-stat-card.light { background-color: #f8f9fa; }
    .user-stat-icon { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .icon-blue { background-color: #e8f0fe; color: #0d6efd; }
    .icon-purple { background-color: #f3e8fe; color: #9333ea; }
    .icon-green { background-color: #e6f8f0; color: #10b981; }
    .icon-grey { background-color: #e9ecef; color: #555; }
    .user-stat-info strong { font-size: 20px; font-weight: 700; color: #222; display: block; }
    .user-stat-info span { font-size: 14px; color: #777; }

    /* Filter Bar */
    .filter-bar-container { display: flex; justify-content: space-between; align-items: center; background-color: #ffffff; padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .page-search-bar { position: relative; width: 350px; }
    .page-search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .page-search-bar input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .filter-tabs { display: flex; gap: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 4px; background-color: #f9f9f9; }
    .filter-tab { padding: 8px 16px; font-size: 14px; font-weight: 600; color: #555; background-color: transparent; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; transition: 0.3s; }
    .filter-tab.active, .filter-tab:hover { background-color: #ffffff; color: #333; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }

    /* User Table */
    .page-table-container { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e9ecef; overflow: hidden; }
    .user-table { width: 100%; border-collapse: collapse; }
    .user-table th, .user-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    .user-table tr:last-child td { border-bottom: none; }
    .user-table th { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; background-color: #fcfcfc; }
    
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #333; font-size: 14px; }
    .user-name { font-weight: 600; color: #222; display: block; }
    
    .role-tag { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 15px; display: inline-block; }
    .role-admin { background-color: #f3e8ff; color: #9333ea; }
    .role-editor { background-color: #e8f0fe; color: #0d6efd; }
    .role-viewer { background-color: #e9ecef; color: #555; }
    
    .status-tag { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; }
    .status-active { color: #10b981; }
    .status-inactive { color: #888; }
    .status-tag::before { content: ""; width: 8px; height: 8px; border-radius: 50%; }
    .status-active::before { background-color: #10b981; }
    .status-inactive::before { background-color: #aaa; }
    
    .action-buttons { display: flex; gap: 10px; }
    .action-btn { background: none; border: 1px solid #ddd; border-radius: 8px; width: 36px; height: 36px; cursor: pointer; font-size: 14px; color: #777; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; transition: 0.3s; }
    .action-btn:hover { background-color: #f4f4f4; }
    .action-btn.btn-delete:hover { background-color: #feebea; border-color: #fdd; color: #dc3545; }

    /* Role Description */
    .section-title { font-size: 22px; font-weight: 700; margin-top: 30px; margin-bottom: 20px; }
    .role-description-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
    .role-card { background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e9ecef; }
    .role-card-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 15px; }
    .icon-admin { background-color: #f3e8ff; color: #9333ea; }
    .icon-editor { background-color: #e6f8f0; color: #10b981; }
    .icon-viewer { background-color: #feebea; color: #dc3545; }
    .role-card h4 { font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #222; }
    .role-card p { font-size: 14px; color: #555; line-height: 1.6; }
    .text-red { color: #dc3545; }

    @media (max-width: 1200px) { .user-stats-grid, .role-description-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 992px) { .filter-bar-container { flex-direction: column; gap: 15px; } .page-search-bar { width: 100%; } }
    @media (max-width: 768px) { .dashboard-layout { grid-template-columns: 1fr; } .sidebar { display: none; } .user-stats-grid, .role-description-grid { grid-template-columns: 1fr; } }
    
    /* Popup thông báo */
    .notification-popup { position: absolute; top: 60px; right: 25px; width: 300px; background: #ffffff; border-radius: 12px; padding: 15px 18px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); display: none; z-index: 9999; border: 1px solid #e4e4e4; }
    .notif-header h4 { margin: 0; font-size: 16px; font-weight: 700; }
    .notif-sub { font-size: 12px; color: #777; }
    .notif-list { list-style: none; padding: 0; margin: 12px 0 0; }
    .notif-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; }
    .notif-item i { font-size: 18px; margin-top: 2px; }
    .notif-title { margin: 0; font-size: 14px; font-weight: 600; }
    .notif-time { font-size: 12px; color: #888; }
    .notif-view-all { width: 100%; margin-top: 10px; padding: 8px 0; background: #4338ca; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 600; }
  </style>

  <body>
    <div class="dashboard-layout">
      <aside class="sidebar">
        <div class="sidebar-header"><h3>3CC Hotel CMS</h3><p>Quản trị nội dung</p></div>
        <nav class="sidebar-nav">
          <ul>
            <li><a href="/auth/tongquan.html"><i class="fa-solid fa-chart-pie"></i><span>Tổng quan</span></a></li>
            <li><a href="/auth/quanlybaiviet.html"><i class="fa-solid fa-file-lines"></i><span>Quản lý bài viết</span></a></li>
            <li><a href="/auth/quanlylivestream.html"><i class="fa-solid fa-video"></i><span>Livestream</span></a></li>
            <li><a href="/auth/thuvienmedia.html"><i class="fa-solid fa-photo-film"></i><span>Thư viện media</span></a></li>
            <li><a href="/auth/nguoidung.html" class="active"><i class="fa-solid fa-users"></i><span>Người dùng</span></a></li>
            <li><a href="/auth/analyticsvaseo.html"><i class="fa-solid fa-arrow-trend-up"></i><span>Analytics & SEO</span></a></li>
            <li><a href="/auth/binhluan.html"><i class="fa-solid fa-comments"></i><span>Bình luận</span></a></li>
            <li><a href="/auth/chiendich.html"><i class="fa-solid fa-bullhorn"></i><span>Chiến dịch</span></a></li>
            <li><a href="/auth/xuatban.html"><i class="fa-solid fa-share-nodes"></i><span>Xuất bản đa kênh</span></a></li>
          </ul>
        </nav>
        <div class="sidebar-footer">
          <a href="/auth/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Đăng xuất</span></a>
          <div class="user-profile"><i class="fa-solid fa-user-circle"></i><div class="user-info"><strong>ADMIN</strong><span>Quản Trị Viên</span></div></div>
        </div>
      </aside>

      <div class="main-content">
        <header class="top-bar">
          <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Search..." /></div>
          <div class="header-icons">
            <button class="notification-btn"><i class="fa-solid fa-bell"></i><span class="notification-dot"></span></button>
            <div class="notification-popup" id="notificationPopup">
              <div class="notif-header"><h4>Thông báo hệ thống</h4><span class="notif-sub">Dành cho quản trị khách sạn</span></div>
              <ul class="notif-list">
                <li class="notif-item"><i class="fa-solid fa-circle-info" style="color:#0d6efd"></i><div><p class="notif-title">Yêu cầu hỗ trợ từ lễ tân</p><span class="notif-time">10 phút trước</span></div></li>
              </ul>
              <button class="notif-view-all">Xem tất cả</button>
            </div>
          </div>
        </header>

        <main class="page-content">
          <div class="page-header-container">
            <div class="page-title-group"><h1 class="page-title">Quản lý người dùng</h1><p class="page-subtitle">Quản lý tài khoản và vai trò của khách sạn</p></div>
            <a href="/auth/themnguoidung.html" class="btn-add-user"><i class="fa-solid fa-plus"></i> Thêm người dùng</a>
          </div>

          <div class="user-stats-grid">
            <div class="user-stat-card">
              <div class="user-stat-icon icon-blue"><i class="fa-solid fa-users"></i></div>
              <div class="user-stat-info"><strong id="total-users">0</strong><span>Tổng người dùng</span></div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-icon icon-purple"><i class="fa-solid fa-user-shield"></i></div>
              <div class="user-stat-info"><strong id="total-admin">0</strong><span>Quản trị viên</span></div>
            </div>
            <div class="user-stat-card">
              <div class="user-stat-icon icon-green"><i class="fa-solid fa-pencil"></i></div>
              <div class="user-stat-info"><strong id="total-editor">0</strong><span>Biên tập viên</span></div>
            </div>
            <div class="user-stat-card light">
              <div class="user-stat-icon icon-grey"><i class="fa-solid fa-eye"></i></div>
              <div class="user-stat-info"><strong id="total-viewer">0</strong><span>Người xem</span></div>
            </div>
          </div>

          <div class="filter-bar-container">
            <div class="page-search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Tìm kiếm người dùng..." id="searchUser" /></div>
            <div class="filter-tabs">
              <button class="filter-tab active" onclick="filterUsers('all')">Tất cả</button>
              <button class="filter-tab" onclick="filterUsers('admin')">Admin</button>
              <button class="filter-tab" onclick="filterUsers('editor')">Editor</button>
              <button class="filter-tab" onclick="filterUsers('viewer')">Viewer</button>
            </div>
          </div>

          <div class="page-table-container">
            <table class="user-table">
              <thead>
                <tr>
                  <th>Người dùng</th>
                  <th>Email</th>
                  <th>Vai trò</th>
                  <th>Trạng thái</th>
                  <th>Số bài viết</th>
                  <th>Đăng nhập lần cuối</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr><td colspan="7" style="text-align:center">Đang tải dữ liệu...</td></tr>
              </tbody>
            </table>
          </div>

          <h2 class="section-title">Mô tả vai trò</h2>
          <div class="role-description-grid">
            <div class="role-card">
              <div class="role-card-icon icon-admin"><i class="fa-solid fa-user-shield"></i></div>
              <h4>Quản trị viên (Admin)</h4><p>Có toàn quyền quản lý hệ thống, người dùng, nội dung.</p>
            </div>
            <div class="role-card">
              <div class="role-card-icon icon-editor"><i class="fa-solid fa-pencil"></i></div>
              <h4>Biên tập viên (Editor)</h4><p>Có thể tạo, chỉnh sửa và xuất bản bài viết.</p>
            </div>
            <div class="role-card">
              <div class="role-card-icon icon-viewer"><i class="fa-solid fa-eye"></i></div>
              <h4>Người xem (Viewer)</h4><p>Chỉ có quyền xem nội dung, <span class="text-red">không thể chỉnh sửa</span>.</p>
            </div>
          </div>
        </main>
      </div>
    </div>

<script>
let allUsers = [];

// --- CẤU HÌNH DỮ LIỆU FAKE ---
const FAKE_DATA = {
  dates: ["Vừa xong", "5 phút trước", "15 phút trước", "1 giờ trước", "Hôm qua", "2 ngày trước"],
  minPost: 0,
  maxPost: 150
};
const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// --- 1. TẢI USER ---
async function loadUsers() {
    try {
        const res = await fetch("/auth/api/users");
        allUsers = await res.json();
        updateStats();
        renderUsers(allUsers);
    } catch (err) {
        console.error(err);
        document.getElementById("userTableBody").innerHTML = `<tr><td colspan="7" style="text-align:center;color:red">Lỗi kết nối API</td></tr>`;
    }
}

// --- 2. XÓA USER (MỚI) ---
async function deleteUser(id) {
    // Tìm user để lấy tên hiển thị confirm cho chắc
    const user = allUsers.find(u => u.id === id);
    if (!user) return;

    // Confirm xác nhận
    const confirmMsg = `Bạn có chắc chắn muốn xóa người dùng "${user.fullname}"?\nHành động này không thể hoàn tác.`;
    if (!confirm(confirmMsg)) return;

    try {
        const res = await fetch(`/auth/api/users/${id}`, {
            method: 'DELETE'
        });
        const data = await res.json();

        if (res.ok) {
            alert("Đã xóa thành công!");
            loadUsers(); // Tải lại bảng
        } else {
            // Hiển thị lỗi từ backend (Ví dụ: Không được xóa Admin)
            alert("Lỗi: " + data.error);
        }
    } catch (err) {
        alert("Lỗi hệ thống khi xóa user");
    }
}

// --- 3. RENDER BẢNG ---
function renderUsers(users) {
    const tbody = document.getElementById("userTableBody");
    tbody.innerHTML = "";

    if(users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center">Không tìm thấy người dùng nào</td></tr>`;
        return;
    }

    users.forEach(u => {
        // Logic Role
        let roleClass = "role-viewer", roleName = "Người xem";
        if(u.role === 'admin') { roleClass = "role-admin"; roleName = "Quản trị viên"; }
        else if(u.role === 'editor') { roleClass = "role-editor"; roleName = "Biên tập viên"; }

        // Logic Fake Data
        let fakePostCount = (u.role === 'admin' || u.role === 'editor') ? getRandomInt(10, 200) : getRandomInt(0, 5);
        const fakeLastLogin = getRandomItem(FAKE_DATA.dates);
        const isOnline = Math.random() < 0.7;
        const statusClass = isOnline ? "status-active" : "status-inactive";
        const statusText = isOnline ? "Đang hoạt động" : "Ngoại tuyến";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>
                <div class="user-info">
                    <div class="user-avatar" style="background-color: ${u.avatar_bg}">${u.avatar_text}</div>
                    <div><span class="user-name">${u.fullname}</span></div>
                </div>
            </td>
            <td>${u.email}</td>
            <td><span class="role-tag ${roleClass}">${roleName}</span></td>
            <td><span class="status-tag ${statusClass}">${statusText}</span></td>
            <td>${fakePostCount}</td>
            <td>${fakeLastLogin}</td>
            <td>
                <div class="action-buttons">
                    <a href="/auth/suanguoidung.html?id=${u.id}" class="action-btn">
                        <i class="fa-solid fa-pencil"></i>
                    </a>
                    <button class="action-btn btn-delete" onclick="deleteUser(${u.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- 4. UPDATE STATS & FILTER ---
function updateStats() {
    document.getElementById("total-users").innerText = allUsers.length;
    document.getElementById("total-admin").innerText = allUsers.filter(u => u.role === 'admin').length;
    document.getElementById("total-editor").innerText = allUsers.filter(u => u.role === 'editor').length;
    document.getElementById("total-viewer").innerText = allUsers.filter(u => u.role === 'viewer').length;
}

function filterUsers(role) {
    document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.classList.remove('active');
        if(btn.innerText.toLowerCase().includes(role) || (role==='all' && btn.innerText==='Tất cả')) 
            btn.classList.add('active');
    });
    if(role === 'all') renderUsers(allUsers);
    else renderUsers(allUsers.filter(u => u.role === role));
}

document.getElementById('searchUser').addEventListener('keyup', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = allUsers.filter(u => u.fullname.toLowerCase().includes(term) || u.email.toLowerCase().includes(term));
    renderUsers(filtered);
});

// Chạy khi load trang
document.addEventListener("DOMContentLoaded", () => {
    loadUsers();
    // Popup thông báo
    const bell = document.querySelector(".notification-btn");
    const popup = document.getElementById("notificationPopup");
    bell.addEventListener("click", (e) => { e.stopPropagation(); popup.style.display = popup.style.display === "block" ? "none" : "block"; });
    document.addEventListener("click", () => popup.style.display = "none");
});
</script>
  </body>
</html>
