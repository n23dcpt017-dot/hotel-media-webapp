<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS - Quản lý bài viết</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  </head>
  <style>
    /* style.css - Giữ nguyên style cũ của bạn */
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; }
    .dashboard-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
    .sidebar { background-color: #ffffff; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; }
    .sidebar-header { padding: 25px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-header h3 { margin: 0 0 5px 0; font-size: 20px; }
    .sidebar-header p { margin: 0; font-size: 14px; color: #888; }
    .sidebar-nav { flex-grow: 1; padding: 20px 15px; }
    .sidebar-nav ul { list-style: none; margin: 0; padding: 0; }
    .sidebar-nav li a { display: flex; align-items: center; padding: 14px 18px; text-decoration: none; color: #555; border-radius: 8px; font-weight: 500; margin-bottom: 5px; transition: 0.3s; }
    .sidebar-nav a i { font-size: 18px; width: 20px; margin-right: 15px; }
    .sidebar-nav a:hover { background-color: #f4f4f4; }
    .sidebar-nav a.active { background-color: #e8f0fe; color: #0d6efd; }
    .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid #f0f0f0; }
    .logout-btn { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: #d9534f; border-radius: 8px; font-weight: 500; transition: 0.3s; margin-bottom: 15px; }
    .logout-btn:hover { background-color: #fdf0f0; }
    .logout-btn i { margin-right: 10px; }
    .user-profile { display: flex; align-items: center; gap: 12px; }
    .user-profile i { font-size: 36px; color: #555; }
    .user-info strong { display: block; font-size: 15px; }
    .user-info span { font-size: 13px; color: #777; }
    .main-content { display: flex; flex-direction: column; height: 100vh; overflow-y: hidden; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
    .top-bar .search-bar { position: relative; width: 300px; }
    .top-bar .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .top-bar .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .notification-btn { background: none; border: none; font-size: 20px; color: #555; cursor: pointer; position: relative; }
    .notification-dot { position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: #dc3545; border-radius: 50%; border: 2px solid #fff; }
    .page-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
    .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title-group .page-title { font-size: 28px; font-weight: 700; margin: 0 0 5px 0; }
    .page-title-group .page-subtitle { font-size: 16px; color: #777; margin: 0; }
    .btn-create-new { display: flex; align-items: center; gap: 8px; background-color: #4338ca; color: #ffffff; border: none; padding: 12px 20px; font-size: 15px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.3s; text-decoration: none; }
    .btn-create-new:hover { background-color: #3730a3; }
    .filter-bar-container { display: flex; justify-content: space-between; align-items: center; background-color: #ffffff; padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .page-search-bar { position: relative; width: 350px; }
    .page-search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    .page-search-bar input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; font-size: 15px; }
    .filter-tabs { display: flex; gap: 10px; }
    .filter-tab { padding: 10px 18px; font-size: 14px; font-weight: 600; color: #555; background-color: transparent; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.3s; text-decoration: none; }
    .filter-tab:hover { background-color: #f4f4f4; }
    .filter-tab.active { background-color: #333; color: #fff; border-color: #333; }
    
    /* --- Lưới bài viết --- */
    .article-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
    .article-card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e9ecef; overflow: hidden; display: flex; flex-direction: column; }
    .card-image-wrapper img { width: 100%; height: 200px; object-fit: cover; display: block; }
    .card-content { padding: 20px; flex-grow: 1; }
    .card-tags { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .category-tag { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 15px; color: #fff; background-color: #0d6efd; }
    .status-tag { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 15px; }
    .status-published { background-color: #e6f8f0; color: #10b981; }
    .status-draft { background-color: #f4f4f4; color: #777; }
    .status-scheduled { background-color: #e8f0fe; color: #0d6efd; }
    .article-title { font-size: 18px; font-weight: 700; color: #222; margin: 0 0 10px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 44px; }
    .article-author { font-size: 14px; color: #777; }
    .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-top: 1px solid #f0f0f0; font-size: 14px; color: #888; }
    .article-stat { display: flex; align-items: center; gap: 6px; }
    .article-actions { display: flex; gap: 10px; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #777; transition: 0.3s; }
    .action-btn.btn-edit:hover { color: #0d6efd; }
    .action-btn.btn-delete:hover { color: #dc3545; }
    
    @media (max-width: 1200px) { .article-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .dashboard-layout { grid-template-columns: 1fr; } .sidebar { display: none; } .article-grid { grid-template-columns: 1fr; } }
  </style>

  <body>
    <div class="dashboard-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>3CC Hotel CMS</h3>
          <p>Quản trị nội dung</p>
        </div>
        <nav class="sidebar-nav">
          <ul>
            <li><a href="/auth/tongquan.html"><i class="fa-solid fa-chart-pie"></i><span>Tổng quan</span></a></li>
            <li><a href="/auth/quanlybaiviet.html" class="active"><i class="fa-solid fa-file-lines"></i><span>Quản lý bài viết</span></a></li>
            <li><a href="/auth/xuatban.html"><i class="fa-solid fa-share-nodes"></i><span>Xuất bản đa kênh</span></a></li>
          </ul>
        </nav>
        <div class="sidebar-footer">
          <a href="/auth/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Đăng xuất</span></a>
          <div class="user-profile"><i class="fa-solid fa-user-circle"></i><div class="user-info"><strong>ADMIN</strong><span>Quản Trị Viên</span></div></div>
        </div>
      </aside>

      <div class="main-content">
        <header class="top-bar">
          <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Search..." /></div>
          <div class="header-icons"><button class="notification-btn"><i class="fa-solid fa-bell"></i><span class="notification-dot"></span></button></div>
        </header>

        <main class="page-content">
          <div class="page-header-container">
            <div class="page-title-group">
              <h1 class="page-title">Quản lý bài viết</h1>
              <p class="page-subtitle">Tạo và quản lý nội dung cho khách sạn</p>
            </div>
            <a href="/auth/taobaiviet.html" class="btn-create-new"><i class="fa-solid fa-plus"></i> Tạo bài viết mới</a>
          </div>

          <div class="filter-bar-container">
            <div class="page-search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Tìm kiếm bài viết..." id="searchInput"/></div>
            <div class="filter-tabs">
              <button onclick="loadPosts('')" class="filter-tab active">Tất cả</button>
              <button onclick="loadPosts('published')" class="filter-tab">Đã xuất bản</button>
              <button onclick="loadPosts('draft')" class="filter-tab">Nháp</button>
            </div>
          </div>

          <div class="article-grid" id="postsGrid">
            <p style="text-align: center; grid-column: 1/-1;">Đang tải dữ liệu...</p>
          </div>
        </main>
      </div>
    </div>

<script>
  // --- 1. HÀM TẢI DỮ LIỆU TỪ SERVER (API) ---
  async function loadPosts(status = '') {
    const grid = document.getElementById("postsGrid");
    
    // Cập nhật UI tab active
    document.querySelectorAll('.filter-tab').forEach(btn => {
        if(btn.textContent === 'Tất cả' && status === '') btn.classList.add('active');
        else if(btn.textContent === 'Đã xuất bản' && status === 'published') btn.classList.add('active');
        else if(btn.textContent === 'Nháp' && status === 'draft') btn.classList.add('active');
        else btn.classList.remove('active');
    });

    try {
        // Gọi API lấy bài viết
        let url = '/auth/api/posts';
        if (status) url += `?status=${status}`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("Lỗi tải dữ liệu");
        
        const posts = await res.json();
        
        renderPosts(posts);

    } catch (err) {
        console.error(err);
        grid.innerHTML = `<p style="color:red; text-align:center; grid-column: 1/-1;">Không thể tải bài viết: ${err.message}</p>`;
    }
  }

  // --- 2. HÀM HIỂN THỊ HTML ---
  function renderPosts(posts) {
    const grid = document.getElementById("postsGrid");
    grid.innerHTML = ""; // Xóa nội dung cũ

    if (posts.length === 0) {
        grid.innerHTML = `<p style="text-align:center; grid-column: 1/-1; color:#888;">Chưa có bài viết nào.</p>`;
        return;
    }

    posts.forEach(post => {
      // Xử lý hiển thị trạng thái
      let statusLabel = "Nháp";
      let statusClass = "status-draft";
      
      if(post.status === "published" || post.status === "da-xuat-ban") {
          statusLabel = "Đã xuất bản"; statusClass = "status-published";
      } else if (post.status === "scheduled" || post.status === "len-lich") {
          statusLabel = "Đã lên lịch"; statusClass = "status-scheduled";
      }

      // Xử lý ngày (QUAN TRỌNG: Hiển thị trực tiếp, KHÔNG new Date() để tránh lỗi)
      const dateDisplay = post.publish_at || "-";

      const html = `
        <article class="article-card">
          <div class="card-image-wrapper">
            <img src="${post.image}" alt="${post.title}" onerror="this.src='/static/images/logo.svg'" />
          </div>
          <div class="card-content">
            <div class="card-tags">
              <span class="category-tag">${post.category || 'Tin tức'}</span>
              <span class="status-tag ${statusClass}">${statusLabel}</span>
            </div>
            <h3 class="article-title">${post.title}</h3>
            <span class="article-author">${post.author}</span>
          </div>
          <div class="card-footer">
            <span class="article-stat"><i class="fa-regular fa-eye"></i> 0</span>
            
            <span class="article-date">${dateDisplay}</span>
            
            <div class="article-actions">
              <a href="/auth/suabaiviet.html?id=${post.id}"><button class="action-btn btn-edit"><i class="fa-solid fa-pencil"></i></button></a>
              <button class="action-btn btn-delete" onclick="deletePost(${post.id})">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </article>
      `;
      grid.innerHTML += html;
    });
  }

  // --- 3. HÀM XÓA BÀI VIẾT ---
  async function deletePost(id) {
    if (!confirm("Bạn có chắc chắn muốn xóa bài viết này không?")) return;
    
    try {
        const res = await fetch(`/auth/api/posts/${id}`, { method: "DELETE" });
        if (res.ok) {
            loadPosts(); // Tải lại danh sách sau khi xóa
        } else {
            alert("Xóa thất bại");
        }
    } catch (err) {
        alert("Lỗi kết nối");
    }
  }

  // Chạy khi tải trang
  document.addEventListener("DOMContentLoaded", () => loadPosts(''));

  // Tìm kiếm (Cơ bản - Lọc trên giao diện)
  document.getElementById('searchInput').addEventListener('keyup', function(e) {
      const term = e.target.value.toLowerCase();
      const cards = document.querySelectorAll('.article-card');
      
      cards.forEach(card => {
          const title = card.querySelector('.article-title').textContent.toLowerCase();
          if(title.includes(term)) card.style.display = 'flex';
          else card.style.display = 'none';
      });
  });
</script>
  </body>
</html>
